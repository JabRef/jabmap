<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>JabMap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/jsmind@0.8.7/style/jsmind.css"/>
  <style>
    html, body { height:100%; margin:0; padding:0; }
    body { display:flex; flex-direction:column; height:100vh; }
    nav.navbar { flex-shrink:0; }
    #jsmind_container {
      flex:1;
      min-width:960px; min-height:540px;
      background:#fff; overflow:auto;
    }
    .icon-btn {
      border:none; background:none;
      width:32px; height:32px;
      margin:2px; padding:0;
      cursor:pointer;
    }
    .icon-btn img { width:100%; height:100%; object-fit:contain; }
    .icon-btn:hover img { filter:brightness(1.2); }
    .node-content { display:flex; align-items:center; }
    .node-left { display:inline-flex; align-items:center; margin-right:4px; }
    .node-icon { width:16px; height:16px; margin-right:2px; vertical-align:middle; }
    .node-text { display:inline-block; vertical-align:middle; white-space: pre-wrap; word-break: break-word; width: auto; }
    .highlight-yellow { background: #d4ac0d; }
    .highlight-green { background: #196F3D; }
    .jsmind-edit { border:none; background:transparent; font:inherit; color:inherit; padding:0; margin:0; width:auto; min-width:60px; outline:none; }
    .node-edit-wrapper { display:flex; align-items:center; }
    .node-edit-icons { margin-right:5px; }
    #icons-list { display: flex; flex-direction: column; }
    #icons-list .icon-btn { width: 24px; height: 24px; }
    #icons-list .icon-shortcut { font-size: 12px; color: #888; margin-right: 8px; min-width: 52px; display: inline-block; text-align: left; }
    #icons-list .icon-row { display: flex; align-items: center; margin-bottom: 4px; }
  </style>
</head>
<body>
<script src="//cdn.jsdelivr.net/npm/jsmind@0.8.7/es6/jsmind.js"></script>
<script src="https://unpkg.com/jsmind@0.8.7/es6/jsmind.draggable-node.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<nav class="navbar navbar-expand-lg bg-body-tertiary px-3">
  <a class="navbar-brand" href="#">JabMap</a>
  <div class="collapse navbar-collapse">
    <div class="d-flex mx-auto align-items-center">
      <div class="dropdown me-2">
        <button class="btn btn-secondary dropdown-toggle"
                id="iconsDropdownBtn"
                data-bs-toggle="dropdown"
                title="Add Icon to Selected Node">
          <i class="bi bi-tags"></i>
        </button>
        <ul class="dropdown-menu p-2" aria-labelledby="iconsDropdownBtn" style="min-width:200px;">
          <li><strong>Icons</strong></li>
          <li><div id="icons-list"></div></li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<div id="jsmind_container"></div>
<script>
  document.addEventListener("DOMContentLoaded", function(){
    const ICONS = [
      { name:"Cycle", url:"data:image/svg+xml,%3Csvg data-v-f38181b0='' id='iconSvg-1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' aria-hidden='true' role='img' viewBox='0 0 24 24'%3E%3Cg fill='none' stroke='%2322b21f' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'%3E%3Cpath d='M22 12c0 6-4.39 10-9.806 10C7.792 22 4.24 19.665 3 16m-1-4C2 6 6.39 2 11.807 2C16.208 2 19.758 4.335 21 8'%3E%3C/path%3E%3Cpath d='m7 17l-4-1l-1 4M17 7l4 1l1-4'%3E%3C/path%3E%3C/g%3E%3C/svg%3E" },
      { name:"Star", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128' x='0' y='0' width='128' height='128'%3E%3Cpath fill='%23FDD835' d='m68.05 7.23l13.46 30.7a7.047 7.047 0 0 0 5.82 4.19l32.79 2.94c3.71.54 5.19 5.09 2.5 7.71l-24.7 20.75c-2 1.68-2.91 4.32-2.36 6.87l7.18 33.61c.63 3.69-3.24 6.51-6.56 4.76L67.56 102a7.033 7.033 0 0 0-7.12 0l-28.62 16.75c-3.31 1.74-7.19-1.07-6.56-4.76l7.18-33.61c.54-2.55-.36-5.19-2.36-6.87L5.37 52.78c-2.68-2.61-1.2-7.17 2.5-7.71l32.79-2.94a7.047 7.047 0 0 0 5.82-4.19l13.46-30.7c1.67-3.36 6.45-3.36 8.11-.01z'/%3E%3C/svg%3E"},
      { name:"Question", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 412 731' fill='%23c81e1e' x='0' y='0' width='412' height='731'%3E%3Cpath fill='%23c81e1e' d='M86 281H12c-7-23-12-46-12-71C0 84 81 0 207 0c117 0 191 64 204 178c1 8 1 17 1 26c0 53-14 98-50 135c-35 35-59 58-97 91c-41 36-41 98-41 144h-77c0-108 24-153 59-188c34-34 83-64 109-97c22-26 28-57 28-85c0-87-49-136-136-136c-88 0-138 55-138 142c0 26 6 49 17 71zm61 373h77v77h-77v-77z'/%3E%3C/svg%3E"},
      { name:"Lamp", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 384 512' fill='%23fdee44' x='0' y='0' width='384' height='512'%3E%3Cpath fill='%23fdee44' d='M272 384c9.6-31.9 29.5-59.1 49.2-86.2c5.2-7.1 10.4-14.2 15.4-21.4c19.8-28.5 31.4-63 31.4-100.3C368 78.8 289.2 0 192 0S16 78.8 16 176c0 37.3 11.6 71.9 31.4 100.3c5 7.2 10.2 14.3 15.4 21.4c19.8 27.1 39.7 54.4 49.2 86.2h160zm-80 128c44.2 0 80-35.8 80-80v-16H112v16c0 44.2 35.8 80 80 80zm-80-336c0 8.8-7.2 16-16 16s-16-7.2-16-16c0-61.9 50.1-112 112-112c8.8 0 16 7.2 16 16s-7.2 16-16 16c-44.2 0-80 35.8-80 80z'/%3E%3C/svg%3E"},
      { name:"Warning", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='64' height='64'%3E%3Cpolygon points='32,6 2,58 62,58' fill='%23ffdd15' stroke='%23e2b800' stroke-width='2'/%3E%3Crect x='29' y='22' width='6' height='20' rx='3' fill='%23222222'/%3E%3Ccircle cx='32' cy='50' r='3' fill='%23222222'/%3E%3C/svg%3E"},
      { name:"Green flag", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2310c613' x='0' y='0' width='24' height='24'%3E%3Cpath fill='%2310c613' fill-rule='evenodd' stroke='%2310c613' stroke-width='2' d='M2 24V2c8-3.524 11 4.644 20 0v12c-8 4.895-13-4.103-20 0'/%3E%3C/svg%3E"},
      { name:"Red flag", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23c61010' x='0' y='0' width='24' height='24'%3E%3Cpath fill='%23c61010' fill-rule='evenodd' stroke='%23c61010' stroke-width='2' d='M2 24V2c8-3.524 11 4.644 20 0v12c-8 4.895-13-4.103-20 0'/%3E%3C/svg%3E"},
      { name:"Comment", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 24 24'%3E%3Crect x='0' y='0' width='24' height='24' rx='8' fill='none'/%3E%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23c01111' x='0' y='0' width='24' height='24'%3E%3Cpath fill='%23c01111' d='M12 9a1 1 0 1 0 1 1a1 1 0 0 0-1-1Zm7-7H5a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h11.59l3.7 3.71A1 1 0 0 0 21 22a.84.84 0 0 0 .38-.08A1 1 0 0 0 22 21V5a3 3 0 0 0-3-3Zm1 16.59l-2.29-2.3A1 1 0 0 0 17 16H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1ZM8 9a1 1 0 1 0 1 1a1 1 0 0 0-1-1Zm8 0a1 1 0 1 0 1 1a1 1 0 0 0-1-1Z'/%3E%3C/svg%3E%3C/svg%3E"},
      { name:"Green eye", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3E%3Crect x='0' y='0' width='512' height='512' rx='8' fill='none'/%3E%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23047612' x='0' y='0' width='512' height='512'%3E%3Ccircle cx='256' cy='256' r='64' fill='%23047612'/%3E%3Cpath fill='%23047612' d='M394.82 141.18C351.1 111.2 304.31 96 255.76 96c-43.69 0-86.28 13-126.59 38.48C88.52 160.23 48.67 207 16 256c26.42 44 62.56 89.24 100.2 115.18C159.38 400.92 206.33 416 255.76 416c49 0 95.85-15.07 139.3-44.79C433.31 345 469.71 299.82 496 256c-26.38-43.43-62.9-88.56-101.18-114.82M256 352a96 96 0 1 1 96-96a96.11 96.11 0 0 1-96 96'/%3E%3C/svg%3E%3C/svg%3E"},
      { name:"Orange eye", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23f5b80f' x='0' y='0' width='512' height='512'%3E%3Ccircle cx='256' cy='256' r='64' fill='%23f5b80f'/%3E%3Cpath fill='%23f5b80f' d='M394.82 141.18C351.1 111.2 304.31 96 255.76 96c-43.69 0-86.28 13-126.59 38.48C88.52 160.23 48.67 207 16 256c26.42 44 62.56 89.24 100.2 115.18C159.38 400.92 206.33 416 255.76 416c49 0 95.85-15.07 139.3-44.79C433.31 345 469.71 299.82 496 256c-26.38-43.43-62.9-88.56-101.18-114.82M256 352a96 96 0 1 1 96-96a96.11 96.11 0 0 1-96 96'/%3E%3C/svg%3E"},
      { name:"Link", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 24 24'%3E%3Crect x='0' y='0' width='24' height='24' rx='8' fill='none'/%3E%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%230788c0' x='0' y='0' width='24' height='24'%3E%3Cpath fill='%230788c0' d='M5 21c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2H5m10.3-5l-2.1-2.1L17 10l-2.8-2.8l-3.8 3.9l-2.2-2.2V16h7.1Z'/%3E%3C/svg%3E%3C/svg%3E"},
      { name:"PDF", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23ca0202' x='0' y='0' width='512' height='512'%3E%3Cpath fill='%23ca0202' d='M0 64C0 28.7 28.7 0 64 0h160v128c0 17.7 14.3 32 32 32h128v144H176c-35.3 0-64 28.7-64 64v144H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0l128 128zM176 352h32c30.9 0 56 25.1 56 56s-25.1 56-56 56h-16v32c0 8.8-7.2 16-16 16s-16-7.2-16-16V368c0-8.8 7.2-16 16-16zm32 80c13.3 0 24-10.7 24-24s-10.7-24-24-24h-16v48h16zm96-80h32c26.5 0 48 21.5 48 48v64c0 26.5-21.5 48-48 48h-32c-8.8 0-16-7.2-16-16V368c0-8.8 7.2-16 16-16zm32 128c8.8 0 16-7.2 16-16v-64c0-8.8-7.2-16-16-16h-16v96h16zm80-112c0-8.8 7.2-16 16-16h48c8.8 0 16 7.2 16 16s-7.2 16-16 16h-32v32h32c8.8 0 16 7.2 16 16s-7.2 16-16 16h-32v48c0 8.8-7.2 16-16 16s-16-7.2-16-16V368z'/%3E%3C/svg%3E"},
      { name:"Alignment", url:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1024 896' fill='%23000000' x='0' y='0' width='1024' height='896'%3E%3Cpath fill='%23000000' d='M960 320H64q-27 0-45.5-18.5T0 256.5T18.5 211T64 192h896q26 0 45 19t19 45.5t-19 45t-45 18.5zM832 128H192q-27 0-45.5-18.5t-18.5-45T146.5 19T192 0h640q26 0 45 19t19 45.5t-19 45t-45 18.5zM128 512q-27 0-45.5-18.5t-18.5-45T82.5 403t45.5-19h768q26 0 45 19t19 45.5t-19 45t-45 18.5H128zm-64 64h896q26 0 45 19t19 45.5t-19 45t-45 18.5H64q-27 0-45.5-18.5T0 640t18.5-45.5T64 576zm256 192h384q26 0 45 19t19 45.5t-19 45t-45 18.5H320q-27 0-45.5-18.5T256 832t18.5-45.5T320 768z'/%3E%3C/svg%3E"}
    ];
    // Define and order the icons array and assign their shortcuts
    const ICON_SHORTCUTS = {
      "Cycle": "Ctrl+1",
      "Star": "Ctrl+2",
      "Question": "Ctrl+3",
      "Lamp": "Ctrl+6",
      "Warning": "Ctrl+7",
      "Green flag": "Ctrl+8",
      "Red flag": "Ctrl+9",
      "Comment": "Ctrl+0",
      "Green eye": "Ctrl+E",
      "Orange eye": "Ctrl+R",
      "Link": "Ctrl+L",
      "PDF": "Ctrl+P",
      "Alignment": "Ctrl+A"
    };
    // Initialize objects for storing node icons, texts, and highlight states
    const nodeIcons = {};
    const nodeTexts = {};
    const nodeHighlights = {};
    // Remove HTML tags and return plain text
    function stripHtml(html) {
      const d = document.createElement("div");
      d.innerHTML = html;
      return d.textContent || d.innerText || "";
    }
    // Define the mind map data structure
    const mind = {
      meta:{ name:"jsMind remote", author:"hizzgdev", version:"0.2" },
      format:"node_tree",
      data:{
        id:"root", topic:"jsMind",
        children:[
          { id:"easy", topic:"Easy", direction:"left", children:[
              {id:"easy1",topic:"Easy to show"},
              {id:"easy2",topic:"Easy to edit"},
              {id:"easy3",topic:"Easy to store"},
              {id:"easy4",topic:"Easy to embed"}
            ]},
          { id:"open", topic:"Open Source", direction:"right", children:[
              {id:"open1",topic:"on GitHub"},
              {id:"open2",topic:"BSD License"}
            ]},
          { id:"powerful", topic:"Powerful", direction:"right", children:[
              {id:"powerful1",topic:"Based on Javascript"},
              {id:"powerful2",topic:"Based on HTML5"},
              {id:"powerful3",topic:"Depends on you"}
            ]},
          { id:"other", topic:"Test Node", direction:"left", children:[
              {id:"other1",topic:"I'm from local variable"},
              {id:"other2",topic:"I can do everything"}
            ]}
        ]
      }
    };
    //Initialize each node’s text, icons array, and highlight state
    function initNodeData(node) {
      nodeTexts[node.id] = stripHtml(node.topic);
      nodeIcons[node.id] = [];
      nodeHighlights[node.id] = "";
      if(node.children) node.children.forEach(initNodeData);
    }
    initNodeData(mind.data);
    // Set jsMind options and create the mind map
    const options = {
      container:"jsmind_container",
      theme:"orange",
      editable:true,
      mode:"full",
      engine:"html"
    };
    const jm = new jsMind(options);
    jm.show(mind);

    // Build the icons dropdown list using the icons and icons shortcuts arrays
    const iconsListDiv = document.getElementById("icons-list");
    iconsListDiv.innerHTML = ICONS.map((icon, i) => `
            <div class="icon-row">
                <button class="icon-btn" title="${icon.name}" data-icon-index="${i}">
                    <img src="${icon.url}" alt="${icon.name}">
                </button>
                <span class="icon-shortcut">${ICON_SHORTCUTS[icon.name] || ""}</span>
            </div>
        `).join('');

    // Attach click events to each icon button in the dropdown to toggle the icon on the selected node
    iconsListDiv.querySelectorAll(".icon-btn").forEach(btn => {
      btn.addEventListener("click", function(e){
        e.preventDefault();
        const sel = jm.get_selected_node();
        if (!sel) return;
        const iconIndex = parseInt(btn.getAttribute("data-icon-index"));
        const icon = ICONS[iconIndex];
        const nodeId = sel.id;
        if (!nodeIcons[nodeId]) nodeIcons[nodeId] = [];
        const idx = nodeIcons[nodeId].indexOf(icon.url);
        if (idx === -1) {
          nodeIcons[nodeId].push(icon.url);
        } else {
          nodeIcons[nodeId].splice(idx, 1);
        }
        renderNodeWithIcons(nodeId, nodeTexts[nodeId]);
      });
    });

    // Function to render a node along with its stored text and icons
    function renderNodeWithIcons(nodeId, newText) {
      nodeTexts[nodeId] = newText;
      const icons = (nodeIcons[nodeId]||[])
              .map(url => `<img class="node-icon" src="${url}">`)
              .join('');
      let textClass = "";
      if(nodeHighlights[nodeId] === "yellow") textClass = "highlight-yellow";
      else if(nodeHighlights[nodeId] === "green") textClass = "highlight-green";
      const html = `
            <div class="node-content">
                <div class="icons-container">
                    <span class="node-left">${icons}</span>
                </div>
                <div class="text-container">
                    <span class="node-text ${textClass}">${newText}</span>
                </div>
            </div>
        `;
      jm.update_node(nodeId, html);
    }

    // When editing begins, set the input value to the node's plain text
    jm.view.add_event('edit_node_begin', function(node){
      var input = document.querySelector('.jsmind-edit');
      if(input && nodeTexts[node.id] !== undefined) {
        input.value = nodeTexts[node.id];
      }
    });

    // When editing ends, update the node with the edited text.
    jm.view.add_event('edit_node_end', function(node, topic){
      renderNodeWithIcons(node.id, topic);
    });

    // Global keydown event for keyboard shortcuts (Ctrl+key) to toggle icons/highlights
    document.addEventListener("keydown", function(e) {
      if (!e.ctrlKey) return;
      e.preventDefault();
      const sel = jm.get_selected_node();
      if (!sel) return;

      function toggleIcon(nodeId, iconName) {
        const icon = ICONS.find(ic => ic.name === iconName);
        if (!icon) return;
        if (!nodeIcons[nodeId]) nodeIcons[nodeId] = [];
        const idx = nodeIcons[nodeId].indexOf(icon.url);
        if (idx === -1) {
          nodeIcons[nodeId].push(icon.url);
        } else {
          nodeIcons[nodeId].splice(idx, 1);
        }
        renderNodeWithIcons(nodeId, nodeTexts[nodeId]);
      }

      function toggleHighlight(nodeId, color) {
        if(nodeHighlights[nodeId] === color) nodeHighlights[nodeId] = "";
        else nodeHighlights[nodeId] = color;
        renderNodeWithIcons(nodeId, nodeTexts[nodeId]);
      }

      switch (e.key.toLowerCase()) {
        case "1": toggleIcon(sel.id, "Cycle"); break;
        case "2": toggleIcon(sel.id, "Star"); break;
        case "3": toggleIcon(sel.id, "Question"); break;
        case "4": toggleHighlight(sel.id, "yellow"); break;
        case "5": toggleHighlight(sel.id, "green"); break;
        case "6": toggleIcon(sel.id, "Lamp"); break;
        case "7": toggleIcon(sel.id, "Warning"); break;
        case "8": toggleIcon(sel.id, "Green flag"); break;
        case "9": toggleIcon(sel.id, "Red flag"); break;
        case "0": toggleIcon(sel.id, "Comment"); break;
        case "e": toggleIcon(sel.id, "Green eye"); break;
        case "r": toggleIcon(sel.id, "Orange eye"); break;
        case "l": toggleIcon(sel.id, "Link"); break;
        case "p": toggleIcon(sel.id, "PDF"); break;
        case "a": toggleIcon(sel.id, "Alignment"); break;
      }
    });

    // Override the default end_edit method to set the new text and update the node
    const originalEndEdit = jm.end_edit;
    jm.end_edit = function(){
      const sel = this.get_selected_node();
      if(!sel) return originalEndEdit.call(this);
      const input = document.querySelector(".jsmind-edit");
      const newText = input ? input.value : stripHtml(sel.topic);
      nodeTexts[sel.id] = newText;
      originalEndEdit.call(this);
      renderNodeWithIcons(sel.id, newText);
      this.select_clear();
      this.select_node(sel.id);
      return true;
    };
    /* Override the default begin_edit method to create a custom editing layout
    that shows the node icons and a plain text input for editing*/
    const originalBeginEdit = jm.begin_edit;
    jm.begin_edit = function(nodeId){
      const node = jm.get_node(nodeId);
      const icons = (nodeIcons[nodeId]||[])
              .map(url => `<img class="node-icon" src="${url}">`)
              .join('');
      let initialText = nodeTexts[nodeId] || stripHtml(node.topic);
      initialText = initialText.replace(/\u00A0/g, ' ');
      const html = `
        <div class="node-edit-wrapper">
          <span class="node-edit-icons">${icons}</span>
          <input class="jsmind-edit" type="text" value="${initialText}"/>
        </div>
      `;
      jm.update_node(nodeId, html);
      setTimeout(() => {
        const input = document.querySelector(".jsmind-edit");
        if(input) {
          input.focus();
          input.select();
          input.addEventListener("keydown", function(e) {
            e.stopPropagation();
            if(e.key === "Enter"){
              e.preventDefault();
              jm.end_edit();
              return false;
            }
          }, true);
        }
      }, 0);
    };

  });
</script>
</body>
</html>