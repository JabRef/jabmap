<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>JabMap - jsMind + Tags & Multi-Icons </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmind@0.8.7/style/jsmind.css"/>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body { display: flex; flex-direction: column; height: 100vh; }
        nav.navbar { flex-shrink: 0; }
        #jsmind_container { flex-grow: 1; min-width: 960px; min-height: 540px; background: #fff; overflow: auto; }
        .dropdown-menu { min-width: 220px; }
        .icon-btn, .tag-btn {
            border: none; background: none; padding: 0 4px; cursor: pointer;
        }
        .icon-btn img { width: 20px; height: 20px; }
        .tag-btn img { width: 18px; height: 18px; }
        .icon-btn:hover, .tag-btn:hover { filter: brightness(1.3); }
        .node-icon { width: 16px; height: 16px; margin-right: 3px; vertical-align: middle; }
        .node-tag { width: 14px; height: 14px; margin-left: 2px; vertical-align: middle; }
        .node-content { display: flex; align-items: center; }
        .node-left { margin-right: 5px; display: flex; gap: 2px; }
        .node-text { position: relative; }
        .node-edit-wrapper {
            display: flex;
            align-items: center;
        }
        .node-edit-icons {
            margin-right: 5px;
            display: flex;
            gap: 2px;
        }
        .jsmind-edit {
            font-size: inherit;
            width: 100%;
            min-width: 60px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-body-tertiary px-3">
    <a class="navbar-brand" href="#">JabMap</a>
    <div>
        <button class="btn btn-secondary" title="Save"><i class="bi bi-save"></i></button>
        <button class="btn btn-secondary" title="Open"><i class="bi bi-folder2-open"></i></button>
        <button class="btn btn-secondary" title="Undo"><i class="bi bi-arrow-counterclockwise"></i></button>
        <button class="btn btn-secondary" title="Redo"><i class="bi bi-arrow-clockwise"></i></button>
        <button class="btn btn-secondary" title="New sibling node"><i class="bi bi-node-plus-fill"></i></button>
        <button class="btn btn-secondary" title="New child node"><i class="bi bi-diagram-2-fill" style="transform: rotate(-90deg); display: inline-block;"></i></button>
        <div class="dropdown d-inline">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="tagsDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" title="Tags">
                <i class="bi bi-tags"></i>
            </button>
            <ul class="dropdown-menu p-3" aria-labelledby="tagsDropdownBtn" style="width: 240px;">
                <li>
                    <div><strong>Tags</strong></div>
                    <div id="tags-list" class="mb-2"></div>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                    <div><strong>Icons</strong></div>
                    <div id="icons-list"></div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Mindmap Container -->
<div id="jsmind_container"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsmind@0.8.7/es6/jsmind.js"></script>
<script>
    // Mindmap data
    var mind = {
        meta: { name: "jsMind remote", author: "hizzgdev@163.com", version: "0.2" },
        format: "node_tree",
        data: {
            id: "root",
            topic: "jsMind",
            children: [
                {
                    id: "easy",
                    topic: "Easy",
                    direction: "left",
                    children: [
                        { id: "easy1", topic: "Easy to show" },
                        { id: "easy2", topic: "Easy to edit" },
                        { id: "easy3", topic: "Easy to store" },
                        { id: "easy4", topic: "Easy to embed" }
                    ]
                },
                {
                    id: "open",
                    topic: "Open Source",
                    direction: "right",
                    children: [
                        { id: "open1", topic: "on GitHub" },
                        { id: "open2", topic: "BSD License" }
                    ]
                },
                {
                    id: "powerful",
                    topic: "Powerful",
                    direction: "right",
                    children: [
                        { id: "powerful1", topic: "Based on Javascript" },
                        { id: "powerful2", topic: "Based on HTML5" },
                        { id: "powerful3", topic: "Depends on you" }
                    ]
                },
                {
                    id: "other",
                    topic: "Test Node",
                    direction: "left",
                    children: [
                        { id: "other1", topic: "I'm from a local variable" },
                        { id: "other2", topic: "I can do everything" }
                    ]
                }
            ]
        }
    };

    var options = {
        container: "jsmind_container",
        theme: "orange",
        editable: true
    };
    var jm = new jsMind(options);
    jm.show(mind);

    // Define tags and icons
    const TAGS = [
        { name: "Reviewed", image: "https://cdn-icons-png.flaticon.com/512/190/190411.png" },
        { name: "ToDo", image: "https://cdn-icons-png.flaticon.com/512/1828/1828817.png" },
        { name: "Important", image: "https://cdn-icons-png.flaticon.com/512/1828/1828843.png" },
        { name: "Reference", image: "https://cdn-icons-png.flaticon.com/512/1828/1828884.png" },
        { name: "Draft", image: "https://cdn-icons-png.flaticon.com/512/3094/3094837.png" }
    ];

    const ICONS = [
        { name: "Plus", image: "https://cdn-icons-png.flaticon.com/512/992/992651.png" },
        { name: "Check", image: "https://cdn-icons-png.flaticon.com/512/190/190411.png" },
        { name: "Star", image: "https://cdn-icons-png.flaticon.com/512/616/616494.png" },
        { name: "Exclamation", image: "https://cdn-icons-png.flaticon.com/512/1828/1828843.png" },
        { name: "Heart", image: "https://cdn-icons-png.flaticon.com/512/1077/1077035.png" },
        { name: "Light", image: "https://cdn-icons-png.flaticon.com/512/1828/1828817.png" }
    ];

    // Display sidebar buttons
    const tagsList = document.getElementById("tags-list");
    tagsList.innerHTML = TAGS.map(tag =>
        `<button class="tag-btn" title="${tag.name}" data-tag-name="${tag.name}" data-tag-image="${tag.image}">
<img src="${tag.image}" alt="${tag.name}">
</button>`
    ).join("");

    const iconsList = document.getElementById("icons-list");
    iconsList.innerHTML = ICONS.map(icon =>
        `<button class="icon-btn" title="${icon.name}" data-icon-name="${icon.name}" data-icon-image="${icon.image}">
<img src="${icon.image}" alt="${icon.name}">
</button>`
    ).join("");

    // Variables to store node data (original text, tags, and icons)
    let nodeOriginalText = {}; // { nodeId: "original text" }
    let nodeTags = {}; // { nodeId: [{name, image}, ...] }
    let nodeIcons = {}; // { nodeId: [{name, image}, ...] }

    // Save the original text for each node
    function initializeOriginalText(nodeData) {
        nodeOriginalText[nodeData.id] = nodeData.topic;
        if (nodeData.children) {
            nodeData.children.forEach(child => initializeOriginalText(child));
        }
    }
    initializeOriginalText(mind.data);

    function stripHtml(html) {
        var tmp = document.createElement("DIV");
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || "";
    }

    // Function to display the node divided (icons & tags left + text right)
    function renderNodeTopic(nodeId) {
        let node = jm.get_node(nodeId);
        let baseTopic = nodeOriginalText[nodeId] || stripHtml(node.topic);

        let iconsHtml = "";
        if (nodeIcons[nodeId] && nodeIcons[nodeId].length > 0) {
            iconsHtml = nodeIcons[nodeId]
                .map(icon => `<img src="${icon.image}" alt="${icon.name}" class="node-icon">`)
                .join("");
        }
        let tagsHtml = "";
        if (nodeTags[nodeId] && nodeTags[nodeId].length > 0) {
            tagsHtml = nodeTags[nodeId]
                .map(tag => `<img src="${tag.image}" alt="${tag.name}" class="node-tag">`)
                .join("");
        }

// Build the structure in two sections
        let finalHtml = `
<div class="node-content">
<span class="node-left">${iconsHtml}${tagsHtml}</span>
<span class="node-text">${baseTopic}</span>
</div>
`;
        jm.update_node(nodeId, finalHtml);
    }

    // When clicking on tag or icon buttons
    tagsList.addEventListener("click", function(e) {
        let btn = e.target.closest(".tag-btn");
        if (btn) {
            let selectedNode = jm.get_selected_node();
            if (!selectedNode) {
                alert("Select a node first!");
                return;
            }
            let tagName = btn.getAttribute("data-tag-name").trim();
            let tagImage = btn.getAttribute("data-tag-image").trim();
            if (!nodeTags[selectedNode.id]) nodeTags[selectedNode.id] = [];
            if (!nodeTags[selectedNode.id].some(tag => tag.name === tagName)) {
                nodeTags[selectedNode.id].push({ name: tagName, image: tagImage });
                nodeOriginalText[selectedNode.id] = stripHtml(selectedNode.topic);
                renderNodeTopic(selectedNode.id);
            }
        }
    });

    iconsList.addEventListener("click", function(e) {
        let btn = e.target.closest(".icon-btn");
        if (btn) {
            let selectedNode = jm.get_selected_node();
            if (!selectedNode) {
                alert("Select a node first!");
                return;
            }
            let iconName = btn.getAttribute("data-icon-name").trim();
            let iconImage = btn.getAttribute("data-icon-image").trim();
            if (!nodeIcons[selectedNode.id]) nodeIcons[selectedNode.id] = [];
            if (!nodeIcons[selectedNode.id].some(icon => icon.name === iconName)) {
                nodeIcons[selectedNode.id].push({ name: iconName, image: iconImage });
                nodeOriginalText[selectedNode.id] = stripHtml(selectedNode.topic);
                renderNodeTopic(selectedNode.id);
            }
        }
    });

    // Show icons and tags during editing
    jm.begin_edit = function(nodeId) {
        let node = jm.get_node(nodeId);
        let baseTopic = nodeOriginalText[nodeId] || stripHtml(node.topic);

        let iconsHtml = "";
        if (nodeIcons[nodeId] && nodeIcons[nodeId].length > 0) {
            iconsHtml = nodeIcons[nodeId]
                .map(icon => `<img src="${icon.image}" alt="${icon.name}" class="node-icon">`)
                .join("");
        }
        let tagsHtml = "";
        if (nodeTags[nodeId] && nodeTags[nodeId].length > 0) {
            tagsHtml = nodeTags[nodeId]
                .map(tag => `<img src="${tag.image}" alt="${tag.name}" class="node-tag">`)
                .join("");
        }

// Draw the node specially during editing: left section is fixed, right section turns into input
        let editId = "edit-" + nodeId;
        let finalHtml = `
<div class="node-edit-wrapper">
<span class="node-edit-icons">${iconsHtml}${tagsHtml}</span>
<input id="${editId}" class="jsmind-edit" type="text" value="${baseTopic}" style="font-size:inherit;width:100%;min-width:60px;box-sizing:border-box;"/>
</div>
`;
        jm.update_node(nodeId, finalHtml);

// Automatically put the cursor in the text box
        setTimeout(() => {
            let editBox = document.getElementById(editId);
            if (editBox) {
                editBox.focus();
                editBox.select();
// On Enter : finish editing only, without adding a new node
                editBox.onkeydown = function(e) {
                    if (e.key === "Enter") {
                        e.preventDefault(); // Prevent adding a new node
                        e.stopPropagation();
                        jm.end_edit();
                        return false;
                    }
// Don't prevent any other key (like Space)
                };
                editBox.onblur = function() {
                    jm.end_edit();
                };
            }
        }, 50);

// Don't call the original begin_edit so jsMind doesn't redraw the node
        return true;
    };

    // After finishing editing, rebuild the node with icons and tags
    jm.end_edit = function() {
        const selectedNode = this.get_selected_node();
        if (selectedNode) {
            let editBox = document.querySelector(".jsmind-edit");
            let newText = (editBox && editBox.value) ? editBox.value : stripHtml(selectedNode.topic);
            nodeOriginalText[selectedNode.id] = newText;
            renderNodeTopic(selectedNode.id);
        }
// Don't call the original end_edit so jsMind doesn't redraw the node
        return true;
    };

    // On startup: rebuild all nodes to divide them
    function renderAllNodes(nodeData) {
        renderNodeTopic(nodeData.id);
        if (nodeData.children) {
            nodeData.children.forEach(child => renderAllNodes(child));
        }
    }
    renderAllNodes(mind.data);

</script>
</body>
</html>
