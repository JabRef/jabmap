<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JabMap - jsMind + Navbar + Tags & Emoji Icons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons for navbar only -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- jsMind CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmind@0.8.7/style/jsmind.css">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { display: flex; flex-direction: column; height: 100vh; }
    nav.navbar { flex-shrink: 0; }
    #jsmind_container {
      flex-grow: 1;
      min-width: 960px;
      min-height: 540px;
      background: #fff;
      overflow: auto;
    }
    .dropdown-menu { min-width: 220px; }
    .icon-btn { border: none; background: none; padding: 0 4px; cursor: pointer; font-size: 1.4em; }
    .icon-btn:hover { filter: brightness(1.3); }
    .tag-btn { margin: 2px 2px 2px 0; }
  </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-body-tertiary px-3">
  <a class="navbar-brand" href="#">JabMap</a>
  <div>
    <button class="btn btn-secondary" title="Save"><i class="bi bi-save"></i></button>
    <button class="btn btn-secondary" title="Open"><i class="bi bi-folder2-open"></i></button>
    <button class="btn btn-secondary" title="Undo"><i class="bi bi-arrow-counterclockwise"></i></button>
    <button class="btn btn-secondary" title="Redo"><i class="bi bi-arrow-clockwise"></i></button>
    <button class="btn btn-secondary" title="New sibling node"><i class="bi bi-node-plus-fill"></i></button>
    <button class="btn btn-secondary" title="New child node"><i class="bi bi-diagram-2-fill" style="transform: rotate(-90deg); display: inline-block;"></i></button>
    <!-- Tags Dropdown Button -->
    <div class="dropdown d-inline">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="tagsDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" title="Tags">
        <i class="bi bi-tags"></i>
      </button>
      <ul class="dropdown-menu p-3" aria-labelledby="tagsDropdownBtn" style="width: 240px;">
        <li>
          <div><strong>Tags</strong></div>
          <div id="tags-list" class="mb-2"></div>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <div><strong>Icons</strong></div>
          <div id="icons-list"></div>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Mindmap Container -->
<div id="jsmind_container"></div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<!-- jsMind JS -->
<script src="https://cdn.jsdelivr.net/npm/jsmind@0.8.7/es6/jsmind.js"></script>
<script>
  // Mindmap data
  var mind = {
    "meta": { "name": "jsMind remote", "author": "hizzgdev@163.com", "version": "0.2" },
    "format": "node_tree",
    "data": {
      "id": "root",
      "topic": "jsMind",
      "children": [
        {
          "id": "easy",
          "topic": "Easy",
          "direction": "left",
          "children": [
            { "id": "easy1", "topic": "Easy to show" },
            { "id": "easy2", "topic": "Easy to edit" },
            { "id": "easy3", "topic": "Easy to store" },
            { "id": "easy4", "topic": "Easy to embed" }
          ]
        },
        {
          "id": "open",
          "topic": "Open Source",
          "direction": "right",
          "children": [
            { "id": "open1", "topic": "on GitHub" },
            { "id": "open2", "topic": "BSD License" }
          ]
        },
        {
          "id": "powerful",
          "topic": "Powerful",
          "direction": "right",
          "children": [
            { "id": "powerful1", "topic": "Based on Javascript" },
            { "id": "powerful2", "topic": "Based on HTML5" },
            { "id": "powerful3", "topic": "Depends on you" }
          ]
        },
        {
          "id": "other",
          "topic": "Test Node",
          "direction": "left",
          "children": [
            { "id": "other1", "topic": "I'm from a local variable" },
            { "id": "other2", "topic": "I can do everything" }
          ]
        }
      ]
    }
  };

  var options = {
    container: 'jsmind_container',
    theme: 'orange',
    editable: true
  };

  var jm = new jsMind(options);
  jm.show(mind);

  // Tags and emoji icons
  const TAGS = ["Reviewed", "ToDo", "Important", "Reference", "Draft"];
  const ICONS = [
    { name: "Plus", icon: "➕" },
    { name: "Check", icon: "✔️" },
    { name: "Star", icon: "⭐" },
    { name: "Exclamation", icon: "❌" }
  ];

  // Render tags buttons
  const tagsList = document.getElementById("tags-list");
  tagsList.innerHTML = TAGS.map(tag =>
          `<button class="btn btn-outline-primary btn-sm tag-btn" data-tag="${tag}">${tag}</button>`
  ).join("");

  // Render icons as emoji buttons
  const iconsList = document.getElementById("icons-list");
  iconsList.innerHTML = ICONS.map(icon =>
          `<button class="icon-btn" title="${icon.name}" data-emoji="${icon.icon}">${icon.icon}</button>`
  ).join("");

  // Store tags per node
  let nodeTags = {}; // { nodeId: [tag1, tag2] }
  let nodeEmoji = {}; // { nodeId: emoji }

  // Add tag to selected node (as plain text)
  tagsList.addEventListener('click', function(e){
    if(e.target.classList.contains('tag-btn')){
      let selectedNode = jm.get_selected_node();
      if(!selectedNode) {
        alert('Select a node first!');
        return;
      }
      let tag = e.target.getAttribute('data-tag');
      if(!nodeTags[selectedNode.id]) nodeTags[selectedNode.id] = [];
      if(!nodeTags[selectedNode.id].includes(tag)) {
        nodeTags[selectedNode.id].push(tag);
        renderNodeTopic(selectedNode.id);
      }
    }
  });

  // Add emoji icon to selected node (manual, always works)
  iconsList.addEventListener('click', function(e){
    let btn = e.target.closest('.icon-btn');
    if(btn){
      let selectedNode = jm.get_selected_node();
      if(!selectedNode) {
        alert('Select a node first!');
        return;
      }
      let emoji = btn.getAttribute('data-emoji');
      nodeEmoji[selectedNode.id] = emoji;
      renderNodeTopic(selectedNode.id);
    }
  });

  // Helper: render topic with emoji and tags
  function renderNodeTopic(nodeId) {
    let node = jm.get_node(nodeId);
    // Remove any previous emoji at start and tags at end
    let baseTopic = node.topic.replace(/^[^\w\[]*\s*/, '').replace(/\s*\[.*?\]/g, '');
    let emoji = nodeEmoji[nodeId] ? nodeEmoji[nodeId] + " " : "";
    let tagsStr = (nodeTags[nodeId] || []).map(t => `[${t}]`).join(' ');
    jm.update_node(nodeId, emoji + baseTopic + (tagsStr ? ' ' + tagsStr : ''));
  }
</script>
</body>
</html>
